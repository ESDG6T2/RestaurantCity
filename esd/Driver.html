 <!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <h1><center>Driver page</center></h1>
        <!-- <link rel="stylesheet" href="style.css"> -->
        <!-- <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">    -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    </head>
    <body>
        <form id="driverForm" method="GET">
            <h4>Driver ID</h4>
            <div class="text">
              <input name="driver" type="text" id="driver" placeholder="Enter your Driver ID." required/>
            </div>
            <div class = "submit">
            <input type="submit" value="Submit">
            </div>
        </form>
        <div id="main-container" class="container"> 
        <table id='driverTable' border='1'>    
            <div class="table">         
                <tr>
                    <th>Delivery man</th>
                    <th>Billing Address</th>
                    <th>Postal Address</th>
                    <th>UserID</th>
                    <th>Contact Number</th>
                    <th>OrderIDss</th>
                    <th>Food List</th>
                    <th>Date/Time</th>
                    <th>Total Amount</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </div>
        </table>
        </div>
        <input type="button" id='return' name='return' value='Return'/>
    </body>

<script>
        $(document).ready(function() {
            // $('#driverTable').hide();
            $('#return').hide();
            $(getAll)
        });

        async function getAll(){
            console.log('heelo')
            var serviceURL = "http://127.0.0.1:5002/getAll";
            try {
                    const response = 
                     await fetch(
                       serviceURL, { method: 'GET' }
                    );
                    const data = await response.json();
                    // console.log(data)
            }catch (error) {
                    // Errors when calling the service; such as network error, 
                    // service offline, etc
                    showError
                    ('There is a problem retrieving driver data, please try again later.<br />'+error);     
            } // error
        };
        function showError(message) {
            // Hide the table and button in the event of error
            $('#driverTable').hide();
            // Display an error under the main container
            $('#main-container')
                .append("<label>"+message+"</label>");
        }
        $("#driverForm").submit(async (event) => {        
                // Change serviceURL to your own
                event.preventDefault();
                $('#return').show();
                var driverId = $('#driver').val();
                var serviceURL = "http://127.0.0.1:5002/driver/" + driverId;
                // console.log(serviceURL)
                // console.log(driverId)
            
                try {
                    const response = 
                     await fetch(
                       serviceURL, { method: 'GET' }
                    );
                    const data = await response.json();
                    // console.log(data)
                    var driver = data.driverId; //the arr is in data.driver of the JSON data
                    // console.log(driver)
                    // array or array.length are falsy
                    if (!driver || !driver.length) {
                        showError('Driver list empty or undefined.')
                    } else {
                        // for loop to setup all table rows with obtained delivery data
                        for(var i = 0; i < driver.length ; i++){
                            var eachRow = "<tr>";
                            eachRow += "<td align='center'>" + driver[i]['driverId'] + "</td>" + 
                        "<td align='center'>" + driver[i]['billingAddress'] + "</td>" + 
                        "<td align='center'>" + driver[i]['postalCode'] + "</td>" + 
                        "<td align='center'>" + driver[i]['userId'] + "</td>" + 
                        "<td align='center'>" + driver[i]['contactNo'] + "</td>" + 
                         "<td align='center'>" + driver[i]['orderId'] + "</td>";
                        eachRow += "<td>";
                        for (var l = 0; l < driver[i]['menuItem'].length ; l++) {
                        // for (const food in orders[i]['menuItem'][l]) {
                            eachRow += driver[i]['menuItem'][l]['menuId'] + ' X'+ driver[i]['menuItem'][l]['Qty'] + '<br>';
                        }
                        eachRow += "</td>";
                        eachRow += "<td align='center'>" + driver[i]['datetime'] + "</td>" + 
                        "<td align='center'>$" + driver[i]['totalAmount'] + "</td>" + 
                        "<td align='center'>" + driver[i]['orderStatus'] +"</td>"+
                        "<td align='center'><input type='button' id='delivered' name='delivered"+driver[i]['orderId']+"' onclick='updateStatusDelivered("+driver[i]['orderId']+")' value='Delivered'/></td>";
                        eachRow += "</tr>";
                        // var rows = "";
                        // eachRow =
                        //         "<td align='center'>" + data.driverId + "</td>" +
                        //         "<td align='center'>" + data.orderId+ "</td>" +
                        //         "<td align='center'>" + data.customer_name + "</td>" +
                        //         "<td align='center'>" + data.contactNo + "</td>"+
                        //         "<td align='center'>" + data.billingAddress + "</td>";
                        //     rows += "<tr>" + eachRow + "</tr>";
                        // // add all the rows to the table
                        $('#driverTable').append(eachRow);
                    }
                    }
                } catch (error) {
                    // Errors when calling the service; such as network error, 
                    // service offline, etc
                    showError
                    ('There is a problem retrieving driver data, please try again later.<br />'+error);     
            } // error
        });

        $( "#return" ).click(function() {
            location.reload(true);
        });

        async function updateStatusDelivered(selectedId) {
        var serviceURL = "http://127.0.0.1:5002/updateOrder";
            
        try {
            const response =
                await fetch(
                serviceURL, { method: 'POST',headers: {
                    'Content-Type': 'application/json'
                    }, body:  JSON.stringify({orderId :selectedId ,action: 'Delivered'}) 
                });
            const data = await response.json();
            if (!response.ok){
                showError(data.message);
            }else{
                location.reload(true);
            }
        } catch (error) {
            // Errors when calling the service; such as network error, 
            // service offline, etc
            showError
            ('There is a problem retrieving books data, please try again later.<br />'+error);
            
        } // error updateStatusDelivered
    }

        </script>